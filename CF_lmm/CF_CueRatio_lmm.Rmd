---
title: "CF_CueRatio_lmm"
author: "Haiyang Jin (hjin317@aucklanduni.ac.nz)"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output: 
  pdf_document:
    number_sections: true
    toc: true
version: "1.0"
---


# Preparations
```{r setup and load the related libraries, include=FALSE}
## set chunk options
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(warning = FALSE)
# knitr::opts_chunk$set(fig.width=7, fig.asp =0.618) 
# knitr::opts_chunk$set(comment = "#") # (NA, to remove all hashes)

## load libraries
# libraries for cleaning data
library(tidyverse)
library(readxl)
library(lme4)
library(lmerTest)
library(emmeans)

folder_lmm <- "lmm_output"

```


## Load data 
```{r read the data file}

# list filenames
file1_list <- list.files(file.path("data", "1"), pattern = "*.xlsx", full.names = TRUE)
file2_list <- list.files(file.path("data", "2"), pattern = "*.xlsx", full.names = TRUE)

# load data
df_raw_E1 <- sapply(file1_list, read_excel, na = "NA", simplify = FALSE) %>% bind_rows(.id = "id") 
df_raw_E2 <- sapply(file2_list, read_excel, na = "NA", simplify = FALSE) %>% bind_rows(.id = "id")
  

# combine data from the two experiments
df_raw_E1_temp <- df_raw_E1 %>% 
  select(-c(SubTrial)) %>% 
  mutate(Probability = 0.5,
         targetDuration = 999,
         Participant = Participant + 100)

df_raw_E2_temp <- df_raw_E2 %>% 
  select(-c(Age, Gender, Ethnicity, Block, FaceIndex)) %>% 
  mutate(Participant = Participant + 200,
         Probability = if_else(grepl("75TopCue", Experiment), 0.75, 0.25))

df_raw <- bind_rows(df_raw_E1_temp, df_raw_E2_temp)
  
df_raw

```

## Tidy data

```{r select certain rows and columns from the data, and calculate the Z value for reaction times}

df_tidy <- df_raw %>% 
  filter(!is.na(isCorrect)) %>%  # remove NA trials
  mutate(Cue = if_else(CuedHalf == "T", "top", "bottom"),
         Congruency = if_else(Congruency == "C", "congruent", "incongruent"),
         Alignment = if_else(Alignment == "A", "aligned", "misaligned"),
         SameDifferent = if_else(SameDifferent == "S", "same", "different"),
         Participant = as_factor(Participant),
         Cue = factor(Cue, levels = c("top", "bottom")),
         Congruency = as_factor(Congruency),
         Alignment = as_factor(Alignment),
         SameDifferent = factor(SameDifferent, levels = c("same", "different")))

```

+ Cue: top vs. bottom
+ Congruency: congruent vs. incongruent
+ Alignment: aligned vs. misaligned
+ SameDifferent: same vs. different

```{r}
# set successive difference coding for fixed effects
contrasts(df_tidy$Cue) <- MASS::contr.sdif(nlevels(df_tidy$Cue)) 
contrasts(df_tidy$Congruency) <- MASS::contr.sdif(nlevels(df_tidy$Congruency)) 
contrasts(df_tidy$Alignment) <- MASS::contr.sdif(nlevels(df_tidy$Alignment))
contrasts(df_tidy$SameDifferent) <- MASS::contr.sdif(nlevels(df_tidy$SameDifferent))

# set successive difference coding for random effects
df_lmm <- df_tidy %>% 
  mutate(
    Cue_C = if_else(Cue == "top", -.5, .5),
    Con_C = if_else(Congruency == "congruent", -.5, .5),
    Ali_C = if_else(Alignment == "aligned", -.5, .5),
    Sam_C = if_else(SameDifferent == "same", -.5, .5),
    
    Cue_Con = Cue_C * Con_C,
    Cue_Ali = Cue_C * Ali_C,
    Cue_Sam = Cue_C * Sam_C,
    Con_Ali = Con_C * Ali_C,
    Con_Sam = Con_C * Sam_C,
    Ali_Sam = Ali_C * Sam_C,
    
    Cue_Con_Ali = Cue_Con * Ali_C,
    Cue_Con_Sam = Cue_Con * Sam_C,
    Cue_Ali_Sam = Cue_Ali * Sam_C,
    Con_Ali_Sam = Con_Ali * Sam_C,
    
    Cue_Con_Ali_Sam = Cue_Con_Ali * Sam_C
  )

# save the data (for fitting model in cluster)
save(df_lmm, file = file.path("data", "df_lmm.RData"))

```


# Responses (d')
## The maximal model
```{r resp max}

  # glmm_resp_zcp <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
  #                          (Cue * Congruency * Alignment * SameDifferent | Participant),
  #                        family = binomial("probit"),
  #                        data = df_tidy,
  #                        verbose = TRUE,
  #                        control = glmerControl(optCtrl = list(maxfun = 1e7))
```

## The zero-correlation-parameter model
```{r resp zcp}

file_resp_zcp <- file.path(folder_lmm, "Resp_lmm_zcp.RData")

# fit the zcp model
if (!file.exists(file_resp_zcp)) {
  glmm_resp_zcp <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                           (Cue_C + Con_C + Ali_C + Sam_C + 
                              Cue_Con + Cue_Ali + Cue_Sam + Con_Ali + Con_Sam + Ali_Sam +
                              Cue_Con_Ali + Cue_Con_Sam + Cue_Ali_Sam + Con_Ali_Sam + 
                              Cue_Con_Ali_Sam || Participant),
                         family = binomial(link = "probit"),
                         data = df_lmm,
                         verbose = TRUE,
                         control = glmerControl(optCtrl = list(maxfun = 1e7))
  )
  
  save(glmm_resp_zcp, file = file_resp_zcp)
} else {
  load(file_resp_zcp)
}

print(summary(glmm_resp_zcp), corr = FALSE)

```

## The reduced model
```{r PCA analysis for resp zcp lmm}
summary(rePCA(glmm_resp_zcp))
```

```{r resp reduced}
file_resp_rdc <- file.path(folder_lmm, "Resp_lmm_rdc.RData")

# fit the zcp model
if (!file.exists(file_resp_rdc)) {
glmm_resp_rdc <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Con_Ali + Con_Sam + Ali_Sam + # Cue_Ali + 
                            Cue_Con_Ali + Cue_Con_Sam + Cue_Ali_Sam # + Con_Ali_Sam + 
                          || Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e7))
)
} else {
  load(file_resp_rdc)
}

print(summary(glmm_resp_rdc), corr = FALSE)
```

## The extended model
```{r resp exteded model}
file_resp_etd <- file.path(folder_lmm, "Resp_lmm_etd.RData")

# fit the etd model
if (!file.exists(file_resp_etd)) {
glmm_resp_etd <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Con_Ali + Con_Sam + Ali_Sam + # Cue_Ali + 
                            Cue_Con_Ali + Cue_Con_Sam + Cue_Ali_Sam # + Con_Ali_Sam + 
                          | Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e7))
)
} else {
  load(file_resp_etd)
}

print(summary(glmm_resp_etd), corr = FALSE)
```

```{r}
# restart from the results of extended model

file_resp_etd1 <- file.path(folder_lmm, "Resp_lmm_etd1.RData")

# fit the etd model
if (!file.exists(file_resp_etd1)) {
  ss <- getME(glmm_resp_etd, c("theta","fixef"))
  glmm_resp_etd1 <- update(glmm_resp_etd,start=ss,control=glmerControl(optCtrl=list(maxfun=1e7)))
} else {
  load(file_resp_etd1)
}

print(summary(glmm_resp_etd1), corr = FALSE)

```


```{r}
# restart from the results of extended1 model

file_resp_etd2 <- file.path(folder_lmm, "Resp_lmm_etd2.RData")

# fit the etd model
if (!file.exists(file_resp_etd2)) {
  ss1 <- getME(glmm_resp_etd1, c("theta","fixef"))
  glmm_resp_etd2 <- update(glmm_resp_etd,start=ss1,control=glmerControl(optCtrl=list(maxfun=1e10)))
} else {
  load(file_resp_etd2)
}

print(summary(glmm_resp_etd2), corr = FALSE)

```

As the extended model (`glmm_resp_etd2`) failed to converge and its gradient was even larger than `glmm_resp_etd1`, the random effects whose variance is the smallest in `glmm_resp_etd` (i.e., `Con_Sam`) is removed, resulting in the updated extended model.

```{r resp exteded3 model}
file_resp_etd3 <- file.path(folder_lmm, "Resp_lmm_etd3.RData")

# fit the etd model
if (!file.exists(file_resp_etd3)) {
glmm_resp_etd3 <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Con_Ali + Ali_Sam + # Cue_Ali + Con_Sam + 
                            Cue_Con_Ali + Cue_Con_Sam + Cue_Ali_Sam # + Con_Ali_Sam + 
                          | Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e10))
)
} else {
  load(file_resp_etd3)
}

print(summary(glmm_resp_etd3), corr = FALSE)
```

As `glmm_resp_etd3` did not converge, the random effects (slopes) whose variances are the smallest (i.e., `Con_Ali`) is removed, making the updated extended model.

```{r resp exteded4 model}
file_resp_etd4 <- file.path(folder_lmm, "Resp_lmm_etd4.RData")

# fit the etd model
if (!file.exists(file_resp_etd4)) {
glmm_resp_etd4 <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Ali_Sam + # Cue_Ali + Con_Ali + Con_Sam + 
                            Cue_Con_Ali + Cue_Con_Sam + Cue_Ali_Sam # + Con_Ali_Sam + 
                          | Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e10))
)
} else {
  load(file_resp_etd4)
}

print(summary(glmm_resp_etd4), corr = FALSE)
```

```{r resp exteded5 model}
file_resp_etd5 <- file.path(folder_lmm, "Resp_lmm_etd5.RData")

# fit the etd model
if (!file.exists(file_resp_etd5)) {
glmm_resp_etd5 <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Ali_Sam + # Cue_Ali + Con_Ali + Con_Sam + 
                            Cue_Con_Sam + Cue_Ali_Sam # + Cue_Con_Ali + Con_Ali_Sam + 
                          | Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e10))
)
} else {
  load(file_resp_etd5)
}

print(summary(glmm_resp_etd5), corr = FALSE)
```

```{r resp extededx model}
file_resp_etdx <- file.path(folder_lmm, "Resp_lmm_etdx.RData")

# fit the etd model
if (!file.exists(file_resp_etdx)) {
glmm_resp_etdx <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (0 + Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Con_Ali + Ali_Sam + # Cue_Ali + Con_Sam + 
                            Cue_Con_Ali + Cue_Con_Sam + Cue_Ali_Sam # + Con_Ali_Sam + 
                          | Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e10))
)
} else {
  load(file_resp_etdx)
}

print(summary(glmm_resp_etdx), corr = FALSE)
```


```{r resp extendedx1 model}
file_resp_etdx1 <- file.path(folder_lmm, "Resp_lmm_etdx1.RData")

# fit the etd model
if (!file.exists(file_resp_etdx1)) {
glmm_resp_etdx1 <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (0 + Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Ali_Sam + # Cue_Ali + Con_Sam + Con_Ali + 
                            Cue_Con_Ali + Cue_Con_Sam + Cue_Ali_Sam # + Con_Ali_Sam + 
                          | Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e10))
)
} else {
  load(file_resp_etdx1)
}

print(summary(glmm_resp_etdx1), corr = FALSE)
```

```{r resp extendedx2 model}
file_resp_etdx2 <- file.path(folder_lmm, "Resp_lmm_etdx2.RData")

# fit the etd model
if (!file.exists(file_resp_etdx2)) {
glmm_resp_etdx2 <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (0 + Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Ali_Sam + # Cue_Ali + Con_Sam + Con_Ali + 
                            Cue_Con_Sam + Cue_Ali_Sam # Cue_Con_Ali + Con_Ali_Sam + 
                          | Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e10))
)
} else {
  load(file_resp_etdx2)
}

print(summary(glmm_resp_etdx2), corr = FALSE)
```

```{r resp extendedx3 model}
file_resp_etdx3 <- file.path(folder_lmm, "Resp_lmm_etdx3.RData")

# fit the etd model
if (!file.exists(file_resp_etdx3)) {
glmm_resp_etdx3 <- glmer(isCorrect ~ Cue * Congruency * Alignment * SameDifferent + Probability + 
                         (0 + Cue_C + Con_C + Sam_C + # Ali_C + 
                            Cue_Con + Cue_Sam + Ali_Sam + # Cue_Ali + Con_Sam + Con_Ali + 
                            Cue_Con_Sam + Cue_Ali_Sam # Cue_Con_Ali + Con_Ali_Sam + 
                          | Participant), # Cue_Con_Ali_Sam
                       family = binomial(link = "probit"),
                       data = df_lmm,
                       verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e10))
)
} else {
  load(file_resp_etdx3)
}

print(summary(glmm_resp_etdx3), corr = FALSE)
```

